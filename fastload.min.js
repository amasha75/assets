'use strict';(function(A,q){"object"===typeof exports&&"undefined"!==typeof module?module.exports=q():"function"===typeof define&&define.amd?define(q):(A=A||self,A.fastloadjs=q())})(this,function(){class A{constructor(){this.clientList=new Map}trigger(a,...b){if((a=this.clientList.get(a))&&0!==a.length)for(let c of a)c.apply(null,b)}listen(a,b){const c=this.clientList.get(a);if(!c)return this.clientList.set(a,[b]),this;for(a=c.length-1;0<=a;a--)if(c[a]===b)return this;c.push(b);return this}remove(a,
b){if(!a)return this.clientList.clear(),this;a=this.clientList.get(a);if(!a)return this;if(b)for(let c=a.length-1;0<=c;c--)a[c]===b&&a.splice(c,1);else a.length=0;return this}}const q=async a=>new Promise(b=>{setTimeout(b,a)});class T{constructor(a){this.tasks=a;this.run()}push(a){this.tasks.push(a);this.run()}clear(){this.tasks=[]}async run(){if(!this.runing){this.runing=!0;for(var a;a=this.tasks.shift();)try{await a()}catch(b){console.error(b)}this.runing=!1}}}class U extends A{constructor(a,b,
c,d){super();this.video=a;this.mediaSource=c;this.q=new T([]);this.done=!1;a=c.addSourceBuffer(d);let e=!1;a.addEventListener("updateend",async f=>{if(!e)try{const {value:g,done:h}=await b.read();g&&this.push(g);h&&(setTimeout(()=>{this.q.push(()=>new Promise(async k=>{this.done=!0;k()}))},8E3),e=!0)}catch(g){this.trigger("error",g)}});a.addEventListener("abort",f=>{console.info(f)});a.addEventListener("error",f=>{console.error(f)});this.sourceBuffer=a}wait(){return new Promise(async a=>{for(;;){if(this.done&&
this.update||"open"!==this.mediaSource.readyState)return a();await q(5E3)}})}get update(){if("open"===this.mediaSource.readyState)return!this.sourceBuffer.updating;console.info("mediaSource.readyState status "+this.mediaSource.readyState);this.q.clear();this.trigger("pause");this.done=!0;return!1}repush(a){this.done=!1;this.push(a)}push(a){this.q.push(()=>new Promise(async(b,c)=>{for(;;)try{if(this.done)return b();if(this.update)try{return this.sourceBuffer.appendBuffer(a),b()}catch(d){if("QuotaExceededError"!==
d.name)throw d;this.trigger("pause");this.sourceBuffer.remove(0,Math.max(1,this.video.currentTime-10));await q(80)}else await q(10)}catch(d){return this.trigger("error",d),c(d)}}));return this}}class V{constructor(a,b,c){this.taskMap={};this.total=this.index=0;if(!isFinite(b)||!isFinite(c)||b>c)throw Error("invalid start or end");let d=0;var e=b;for(b=!1;;){let f=e+a;f>c&&(f=c,b=!0);if(e>=f)break;this.taskMap[d]={m:e,n:f,no:d};if(b)break;e=f;d++}this.total=Object.keys(this.taskMap).length}next(a=
10){const b=[];a=Math.min(this.index+a,this.total);let c=!0,d=this.index;for(let e=this.index;e<a;e++){const f=this.taskMap[e];f.done?c&&(d=f.no+1):(c=!1,b.push(f))}this.index=d;return b}getMap(){return this.taskMap}seekTo(a){if(a>=this.total)throw Error("index error");this.index=a}done(a){this.taskMap[a]?this.taskMap[a].done=!0:console.error("error in done")}}class W{constructor(a){this.init=a;this.index=0;this.dataMap={};this.dataMapArray=[];const b=this,c=async d=>{const {data:e,done:f,err:g}=
await b.get();g?d.error(g):(e&&d.enqueue(new Uint8Array(e)),f&&d.close())};this.stream=new ReadableStream({async start(d){await c(d)},async pull(d){await c(d)}})}async get(){for(;;){if(this.destroyed)return{done:!0,err:null,data:null};const a=this.dataMapArray[this.index];if(a)return this.index++,a;await q(100)}}destroy(){this.destroyed=!0}item(a){return this.dataMap[a]}push(a,b){this.dataMap[a]=b;this.dataMapArray.push(b)}getResponse(){return new Response(this.stream,this.init)}}class X{constructor(a,
b,c,d){this.threadNum=a;this.retry=b;this.callback=c;this.finish=d;this.t=0;this.tasks=[];this.pause=!1}async thread(a){for(a=!1;;)if(this.pause)await q(100);else{var b=this.get();if(b)b=await this.do(b),await this.taskOneDone(b)&&(a=!0);else if(await q(100),a)break}this.taskDone()}push(a){this.tasks.push(a);this.t<this.threadNum&&(this.thread(this.t),this.t++)}get(){return this.tasks.pop()}async taskOneDone(a){return await this.callback(a)}taskDone(){this.t--;0>=this.t&&this.finish()}async do(a){const b=
this.retry;let c={};for(let d=0;d<b;d++)try{c=await a();break}catch(e){console.error(e)}return c}}const Y=(a,b,c)=>{a=a.toString().replace(/\.(mp4|webm)/,`/${b}-${c-1}.ts`);return new Request(a,{method:"GET"})};class Z{constructor(a){this.requestBuilder=a?a:this.buildRequest}async fetch(a,b,c,d){a=this.requestBuilder(a,b,c);return await this.send(a,d)}build(a,b){return 0>=a&&0>=b?{method:"GET"}:{method:"GET",headers:{Range:`bytes=${a?a:0}-${b?b-1:""}`}}}buildRequest(a,b,c){b=this.build(b,c);return new Request(a,
b)}async send(a,b){const c=new Promise((d,e)=>{setTimeout(()=>{e("timeout")},b.timeout)});a=fetch(a,{cache:!1===b.cache?"reload":"force-cache"});return await Promise.race([a,c])}}class aa{static async get(a,b,c,d){this.fetchInstance||(this.fetchInstance=new Z(Y));return await this.fetchInstance.fetch(a,b,c,d)}static async fetch(a,b,c,d){a=await this.get(a,b,c,d);return this.parse(a,d)}static async parse(a,b){if(![200,206,304].includes(a.status))throw Error(a.statusText);const c=new Promise((e,f)=>
{setTimeout(()=>{f("readtimeout")},b.readtimeout)}),d=new Promise(async(e,f)=>{try{const g=await a.arrayBuffer();e({no:null,data:g,err:null})}catch(g){f(g)}});return Promise.race([c,d])}}class ba{constructor(){}static wrap(a,b,c,d,e,f){return async()=>{let g={no:e,data:null,err:null},h;const k=d-c;let m={timeout:15E3,readtimeout:3E4,cache:!0};for(let u=0;u<a;u++)try{h=b();g=await aa.fetch(h,c,d,m);g.no=e;g.err=null;const p=g.data?g.data.byteLength:-1;if(p!==k)throw Error(`short read error:expect ${k},got ${p}`);
break}catch(p){if(f.item(e))break;m.cache=!1;console.error(p,u,h,c,d,e);g={no:e,err:p,data:null};await q(2E3)}return g}}}class E{constructor(){this.clientList=new Map}trigger(a,...b){if((a=this.clientList.get(a))&&0!==a.length)for(let c of a)c.apply(null,b)}listen(a,b){const c=this.clientList.get(a);if(!c)return this.clientList.set(a,[b]),this;for(a=c.length-1;0<=a;a--)if(c[a]===b)return this;c.push(b);return this}remove(a,b){if(!a)return this.clientList.clear(),this;a=this.clientList.get(a);if(!a)return this;
if(b)for(let c=a.length-1;0<=c;c--)a[c]===b&&a.splice(c,1);else a.length=0;return this}}class ca extends E{constructor(a){super();this.addr=a;this.$ws=null;this.tasks=[];this.runing=!1;a&&this.connect()}update(a){this.addr=a;this.connect()}connect(){!this.$ws||this.$ws.readyState!=this.$ws.OPEN&&this.$ws.readyState!=this.$ws.CONNECTING?(this.$ws=new WebSocket(this.addr),this.$ws.binaryType="arraybuffer",this.$ws.onopen=a=>{this.trigger("open",a);this.stopconnect();this.notify()},this.$ws.onmessage=
a=>{this.trigger("message",a)},this.$ws.onclose=a=>{this.trigger("close",a);this.startconnect()},this.$ws.onerror=a=>{this.trigger("error",a);this.startconnect()}):this.stopconnect()}startconnect(){clearInterval(this.timer);this.timer=setInterval(()=>{!1!==window.navigator.onLine&&this.connect()},2E3)}stopconnect(){clearInterval(this.timer)}notify(){if(!this.runing){this.runing=!0;if(this.$ws&&this.$ws.readyState==this.$ws.OPEN){let a;for(;a=this.tasks.shift();)this.$ws.send(a)}else this.startconnect();
this.runing=!1}}sendJson(a){try{const b=JSON.stringify(a);b&&(this.tasks.push(b),this.notify())}catch(b){console.error(b)}return this}}class v extends E{constructor(a){super();v.ws||(v.ws=new ca(a),v.ws.listen("open",()=>{v.ev&&v.ws.sendJson({listen:!0,event:v.ev})}),v.ws.listen("message",b=>{const {ev:c,data:d}=v.dispatch(b);this.trigger(c,d)}))}static getWs(a,b,c){this.single||(this.ev=c,this.dispatch=b,this.single=new this(a));a&&v.ws.update(a);""===c?(this.ev&&this.ws.sendJson({listen:!1,event:this.ev}),
this.ev=c):c&&c!==this.ev&&(this.ev&&this.ws.sendJson({listen:!1,event:this.ev}),this.ws.sendJson({listen:!0,event:c}),this.ev=c);return this.single}sendJson(a){v.ws.sendJson(a);return this}}const da=localStorage.getItem("ws")||"wss://ws.feds.club/uid/";let x="";const F=a=>{let b="";b=a?`rtc:${a}`:a;a=da+B();return v.getWs(a,c=>{c=JSON.parse(c.data);return{ev:`${c.event}`,data:c}},b)},B=()=>{if(x)return x;x=sessionStorage.getItem("uid");if(!x||36!=x.length){function a(){return(65536*(1+Math.random())|
0).toString(36)}x=a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a();sessionStorage.setItem("uid",x)}return x},ea=async a=>new Promise(b=>{setTimeout(b,a)}),I=sessionStorage.getItem("loglevel"),r=["warn","info","log"].includes(I)?console.warn.bind(console):()=>{},G=["info","log"].includes(I)?console.info.bind(console):()=>{},n=["log"].includes(I)?console.log.bind(console):()=>{},M=(a,b)=>{if(!a)return b;if(!b)return a;const c=new Uint8Array(a.byteLength+b.byteLength);c.set(new Uint8Array(a),0);c.set(new Uint8Array(b),
a.byteLength);return c.buffer};class fa{constructor(a,b,c){this.id=a;this.servers=b;this.onmsg=c;this.restart=this.rx=this.tx=0;this.init()}init(){if(this.c)try{this.c.close()}catch(a){n(a)}this.c=new RTCPeerConnection(this.servers);this.c.onnegotiationneeded=async a=>{n(a);try{const b=await this.c.createOffer();await this.c.setLocalDescription(b);F().sendJson({event:"offer",to:this.id,from:B(),data:b});n(b)}catch(b){r(b)}};this.c.ondatachannel=a=>{if(this.dc)try{this.dc.close()}catch(b){n(b)}this.dc=
a.channel;this.dc.binaryType="arraybuffer";this.dcInit();n(a)};this.c.onconnectionstatechange=a=>{n(a)};this.c.onicecandidateerror=a=>{r(a)};this.c.onicegatheringstatechange=a=>{n(a)};this.c.oniceconnectionstatechange=a=>{n(a)};this.c.onicecandidate=a=>{n(a);a.candidate&&(a={event:"candidate",from:B(),to:this.id,data:a.candidate},F().sendJson(a),n("send candidate",a))}}async connect(){n("i connect ",this.id);const a=()=>{this.init();if(this.dc)try{this.dc.close()}catch(b){n(b)}this.dc=this.c.createDataChannel("dc",
{maxPacketLifeTime:2E3});this.dc.binaryType="arraybuffer";this.dcInit()};this.c&&"connected"==this.c.connectionState&&this.dc&&"open"==this.dc.readyState?(G("connection to ",this.id," is already open"),this.send(JSON.stringify({event:"ping"})),clearTimeout(this.restart),this.restart=setTimeout(()=>a(),5E3)):a()}dcInit(){window.addEventListener("beforeunload",()=>{this.c.close();this.dc.close()});this.dc.onopen=a=>{r("dc open me : "+B()+" remote: "+this.id,a);this.onmsg("open",a)};this.dc.onclose=
a=>{r("dc close "+this.id,a);this.onmsg("close",a)};this.dc.onerror=a=>{r("dc error "+this.id,a);this.onmsg("error",a)};this.dc.addEventListener("closing",a=>{r("dc closing "+this.id,a);this.onmsg("closing",a)});this.dc.onmessage=async a=>{clearTimeout(this.restart);let b=a.data;b instanceof Blob&&(b=await a.data.arrayBuffer());this.rx=b instanceof ArrayBuffer?this.rx+b.byteLength:this.rx+b.length;this.onmsg("message",{data:b})}}async onOffer(a){"closed"==this.c.signalingState?r("onOffer error signalingState is closed"):
(await this.c.setRemoteDescription(a),a=await this.c.createAnswer(),await this.c.setLocalDescription(a),a={event:"answer",from:B(),to:this.id,data:a},n("send answer",a),F().sendJson(a))}async onAnswer(a){["closed"].includes(this.c.signalingState)?r("onAnswer error signalingState is "+this.c.signalingState):(await this.c.setRemoteDescription(a),G("setRemoteDescription",a))}async onCandidate(a){["closed"].includes(this.c.signalingState)?r("onCandidate error signalingState is "+this.c.signalingState):
(this.c.addIceCandidate(a),n("made connection ",this.id))}send(a){if(this.dc)if("open"!==this.dc.readyState)n("data channel to "+this.id+" is not open");else try{const b=this.dc.send(a);this.tx=a instanceof ArrayBuffer?this.tx+a.byteLength:this.tx+a.length;return b}catch(b){r(b),this.connect()}else n("data channel to "+this.id+" is not avaiable")}stat(){return{tx:this.tx,rx:this.rx,state:this.dc?this.dc.readyState:"",cstate:this.c?this.c.connectionState:"",istate:this.c?this.c.iceConnectionState:
"",gstate:this.c?this.c.iceGatheringState:""}}}class N{constructor(a,b,c,d){this.id=a;this.passive=b;this.servers=c;this.state=2;this.conn=new fa(a,c,(e,f)=>{"message"==e?d("message",f):(this.state="open"==e?0:1,d(e,f))})}connect(){this.passive=!1;this.conn.connect()}waitForConnect(){this.passive=!0}onOffer(a){this.conn.onOffer(a)}onAnswer(a){this.conn.onAnswer(a)}onCandidate(a){this.conn.onCandidate(a)}send(a){return this.conn.send(a)}stat(){return this.conn.stat()}}const t=new Map;class ha extends E{constructor(a){super();
this.servers=a}createPassive(a){const b=new N(a,!0,this.servers,(c,d)=>{this.trigger(c,{uid:a,e:d})});t.set(a,b);b.waitForConnect()}createPositive(a){const b=new N(a,!1,this.servers,(c,d)=>{this.trigger(c,{uid:a,e:d})});t.set(a,b);b.connect()}ensureWaitIds(a){a.forEach(b=>{t.has(b)?t.get(b).waitForConnect():this.createPassive(b)})}ensureToConnect(a){t.has(a)?t.get(a).connect():this.createPositive(a)}async onOffer(a,b){if(a=t.get(a))a.onOffer(b);else console.error("onOffer peer not found error")}async onAnswer(a,
b){if(a=t.get(a))a.onAnswer(b);else console.error("onAnswer peer not found error")}async onCandidate(a,b){if(a=t.get(a))a.onCandidate(b);else console.error("onCandidate peer not found error")}sendTo(a,b){const c=t.get(a);if(c)return c.send(b);console.error("uuid "+a+" not connected")}broadcast(a){t.forEach(b=>{b.send(a)})}getPeers(){return t.keys()}getStats(){const a={};t.forEach(b=>{a[b.id]=b.stat()});return a}}class ia extends E{constructor(a){super();this.servers=a;this.buffers=new Map;this.m=
new ha(a);this.m.listen("message",b=>{const c=b.e.data;if(c instanceof ArrayBuffer)return this.extract(c,b.uid);this.trigger("message",b)});this.m.listen("open",b=>this.trigger("open",b));this.m.listen("close",b=>this.trigger("close",b));this.m.listen("error",b=>this.trigger("error",b));this.id=B()}extract(a,b){try{let m=String.fromCharCode.apply(null,new Uint8Array(a.slice(0,30))).trim();if(/^[!-~]+$/.test(m)){var c=a.slice(30),[d,e,f]=JSON.parse(m),g=this.buffers.get(d);g?g[e]=c:(a=[],a[e]=c,this.buffers.set(d,
a));this.trigger("buffer.recv",{id:d,buffer:c,i:e,n:f,uid:b});c=!0;var h=this.buffers.get(d);for(a=0;a<f;a++)h[a]||(c=!1);if(c){var k=h[0];for(c=1;c<f;c++)k=M(k,h[c]);this.trigger("buffer",{id:d,buffer:k,uid:b});this.buffers.delete(d)}}else this.trigger("message.buffer",{data:a,uid:b})}catch(m){console.error(m)}}init(){F().listen("offer",a=>{this.onOffer(a)}).listen("answer",a=>{this.onAnswer(a)}).listen("candidate",a=>{this.onCandidate(a)}).listen("online",a=>{a.id!=this.id&&this.connectId(a.id)}).listen("init",
a=>{this.waitForIds(a.ids)})}sendTo(a,b){return this.m.sendTo(a,b)}broadcast(a){return this.m.broadcast(a)}getPeers(){return this.m.getPeers()}getStats(){return this.m.getStats()}async sendBuffer(a,b,c,d){b=this.splitBuffer(b,c);for(c=0;c<b.length;c++){const e=b[c];if(d(c,e))break;this.sendTo(a,e.data);await ea(500)}}broadcastBuffer(a,b){this.splitBuffer(a,b).forEach(c=>{this.broadcast(c.data)})}splitBuffer(a,b){let c=0,d=!1;const e=[],f=Math.ceil(a.byteLength/51200);for(;;){const k=51200*c;let m=
51200*(c+1);m>=a.byteLength&&(m=a.byteLength,d=!0);const u=a.slice(k,m);var g=JSON.stringify([b.substr(0,20),c,f]);var h=30-g.length;g=0<h?g+" ".repeat(h):g;{h=new ArrayBuffer(g.length);const p=new Uint8Array(h);for(let w=0,z=g.length;w<z;w++)p[w]=g.charCodeAt(w);g=h}e.push({start:k,end:m,i:c,data:M(g,u)});c++;if(d)return e}}onOffer(a){this.m.onOffer(a.from,a.data)}onAnswer(a){this.m.onAnswer(a.from,a.data)}onCandidate(a){this.m.onCandidate(a.from,a.data)}connectId(a){this.m.ensureToConnect(a)}waitForIds(a){this.m.ensureWaitIds(a)}}
class O extends ia{constructor(a){super(a);this.refBuffers=new Map;this.founders=new Map;this.founderTimers={};this.queries=new Map;this.resolver=new Map;this.waitres=new Map;this.listen("message",b=>{const c=b.uid;b=b.e.data;try{const {event:d,data:e}=JSON.parse(b);this.trigger(d,{data:e,uid:c})}catch(d){console.error(d)}});this.listenInit()}query(a,b,c){this.founders.set(`${a}:${b}`,[]);this.resolver.set(a,c);this.broadcast(JSON.stringify({event:"query",data:{id:a,index:b}}))}async found(a,b){var c=
this.resolver.get(a);if(c){var d=`${a}:${b}`;(c=await c(a,b))?(this.refBuffers.set(d,c),(c=this.queries.get(d))&&c.length&&c.forEach(e=>{this.sendTo(e,JSON.stringify({event:"found",data:{id:a,index:b}}))}),this.queries.delete(d),(c=this.waitres.get(d))&&this.quit(c,a,b),this.waitres.delete(d)):r("resolve has no buffer for ",a,b)}else r("no resolve found for ",a)}clear(){this.broadcast(JSON.stringify({event:"quit",data:{id:"",index:0}}))}quit(a,b,c){this.sendTo(a,JSON.stringify({event:"quit",data:{id:b,
index:c}}))}listenInit(){const a={},b={};this.listen("ping",({uid:c})=>{G("got ping from ",c);this.sendTo(c,JSON.stringify({event:"pong"}))});this.listen("pong",({uid:c})=>{G("got pong from ",c)});this.listen("quit",async({data:c,uid:d})=>{const {id:e,index:f}=c;0==f&&""==e?b[d]=+new Date:a[`${e}|${f}`]={time:+new Date,uid:d}});this.listen("query",async({data:c,uid:d})=>{const {id:e,index:f}=c;c=`${e}:${f}`;const g=this.queries.get(c);g?g.push(d):this.queries.set(c,[d]);await this.found(e,f)});this.listen("found",
({data:c,uid:d})=>{const {id:e,index:f}=c,g=`${e}:${f}`;let h=this.founders.get(g);if(!h)return r(g+" is already resolved");h.push(d);clearTimeout(this.founderTimers[g]);this.founderTimers[g]=setTimeout(async()=>{var k=this.resolver.get(e);k&&await k(e,f)||(k=h[Math.floor(Math.random()*h.length)],this.sendTo(k,JSON.stringify({event:"resolve",data:{id:e,index:f}})),this.waitres.set(g,k),this.founders.delete(g))},100)});this.listen("resolve",async({data:c,uid:d})=>{delete b[d];const {id:e,index:f}=
c;if(c=this.refBuffers.get(`${e}:${f}`)){const g=`${e}|${f}`;return await this.sendBuffer(d,c,g,()=>{if(b[d])return!0;const h=a[g];if(h&&d==h.uid&&6E4>+new Date-h.time)return h.time=0,!0})}return console.error("unresolved",e,f)});this.listen("buffer.recv",async c=>{this.trigger("buffer.progress",c);const [d,e]=c.id.split("|"),f=this.resolver.get(d);f&&await f(d,e)&&this.quit(c.uid,d,e)});this.listen("buffer",({id:c,buffer:d})=>{let [e,f]=c.split("|");this.waitres.delete(e);f=Number(f);this.trigger("data",
{id:e,index:f,buffer:d})})}}const P={iceServers:[{urls:"stun:119.29.1.39:3478"},{urls:"turn:119.29.1.39:3478",username:"su",credential:"su"}]};let l;class J extends A{constructor(a){super();this.defaultOpts={retry:5,thread:2,thunk:524288};this.initial=!1;this.rtcEvcancel=()=>{};this.rtcFound=0;this.config=Object.assign({},this.defaultOpts,a);this.config.nop2p||l||!window.RTCPeerConnection||(l=new O(P),l.init())}start(a){const {thread:b,thunk:c,start:d,end:e,retry:f}=this.config;this.dispatcher||(this.dispatcher=
new V(c,Number(d),Number(e)));this.stream=new W(null);this.worker=new X(b,f,g=>this.taskDone(g),()=>{this.taskFinish()});a||(this.init(),this.initial=!0);this.worker.pause=a;this.config.nop2p||!window.RTCPeerConnection||this.rtcLoop||!1===a||this.config.meta==this.config.req||(this.rtcLoop=setTimeout(()=>this.rtcInit(),1E3));return this}pause(a){this.worker&&(this.worker.pause=a);a||this.initial||(this.init(),this.initial=!0)}init(){const {thread:a}=this.config;let b=0;for(;b<a;){const c=this.dispatcher.next(10+
a);if(c.length)for(let d of c)if(!d.start){this.worker.push(this.taskWrap(d));this.trigger("res.start",d);d.start=+new Date;break}b++}}destroy(){this.remove("");this.pause(!0);this.stream.destroy();this.stream=null;this.rtcReset();this.refBuffer&&(this.refBuffer.q.clear(),this.refBuffer=null)}seekTo(a){this.pause(!1);const b=this.dispatcher.getMap(),c=this.dispatcher.total;for(let d=0;d<c;d++)if(b[d].begin>=a){a=Math.max(d-1,0);this.dispatcher.seekTo(a);this.cachefill(a);break}}cachefill(a){const b=
this.dispatcher.total;let c=!1;for(;a<b;a++){const d=this.stream.item(a);if(!d||d.err||!d.data)break;c||(this.refBuffer.q.clear(),c=!0);this.refBuffer.repush(d.data)}}taskWrap(a){const {m:b,n:c,no:d}=a;let e=0;const f=[];return ba.wrap(this.config.retry,()=>{e++;const g=[this.config.req].concat(this.config.mirrors);let h=g[d%g.length];if(1>=e)return f.push(h),h;h=this.getBestURL(g,f);f.push(h);return h},b,c,d,this.stream)}getBestURL(a,b){const c=a.filter(d=>!b.includes(d));return c.length?c[Math.floor(Math.random()*
c.length)]:a[Math.floor(Math.random()*a.length)]}async taskDone(a){if(!this.stream)return!0;if(-1===a.no)return this.triggerNextTask();const b=this.stream.item(a.no);b||(this.stream.push(a.no,a),this.trigger("res.done",a));this.dispatcher.done(a.no);!this.config.nop2p&&window.RTCPeerConnection&&this.config.meta!=this.config.req&&(b&&!b.err||a.data&&!a.err)&&l.found(this.config.meta,a.no);return!b&&a.err?(this.err=a.err,!0):this.err?!0:this.triggerNextTask()}async triggerNextTask(){const a=this.dispatcher.next(10+
this.config.thread);if(!a.length)return!0;const b=+new Date;if(!this.rtcFound)for(let d of a)if(!d.start)return this.worker.push(this.taskWrap(d)),this.trigger("res.start",d),d.start=b,!1;let c;for(let d of a)if(!d.start){if(!d.rstart){c=d;break}c||(c=d);b-d.rstart>b-c.rstart&&(c=d)}if(c)return this.worker.push(this.taskWrap(c)),this.trigger("res.start",c),c.start=b,!1;this.worker.push(async()=>{await q(200);return{no:-1,data:null,err:null}})}taskFinish(){this.stream&&this.stream.push(this.dispatcher.total,
{done:!0,data:null,err:null,no:1E9})}rtcInit(){clearTimeout(this.rtcLoop);const a=c=>{l.query(this.config.meta,c,(d,e)=>{if(this.stream)return(d=this.stream.item(e))?d.data:d})};a(0);const b=()=>{const c=this.dispatcher.next(10+this.config.thread);var d=l.getStats();this.trigger("rtc.stat",d,l.id);if(c.length){a:{for(let e in d)if(d[e]&&"open"==d[e].state){d=!0;break a}d=!1}if(d){d=+new Date;let e;for(let f of c)if(!f.rstart){if(!f.start){e=f;break}e||(e=f);d-f.start>d-e.start&&(e=f)}e&&(a(e.no),
e.rstart=d,this.trigger("res.rtc.start",e))}this.rtcLoop=setTimeout(b,(this.worker&&this.worker.pause?5E3:0)+2E3)}else this.rtcLoop=setTimeout(b,2E3)};this.rtcLoop=setTimeout(b,2E3);this.rtcEvcancel=this.rtcEventInit()}rtcEventInit(){const a=[],b=({id:e,i:f,n:g,uid:h})=>{const [k,m]=e.split("|");this.config.meta==k&&this.trigger("res.rtc.progress",{i:f,n:g,uid:h,no:m})};l.listen("buffer.progress",b);a.push(()=>{l.remove("buffer.progress",b)});const c=({id:e,index:f,buffer:g})=>{g={no:f,data:g,err:null};
if(this.stream&&this.config.meta==e){this.rtcFound++;l.found(this.config.meta,f);e=this.stream.item(f);if(!e||e.err)this.stream.push(f,g),this.trigger("res.rtc.done",g);this.dispatcher.done(f)}};l.listen("data",c);a.push(()=>{l.remove("data",c)});const d=()=>{const e=l.getStats();this.trigger("rtc.stat",e)};l.listen("open",d);a.push(()=>{l.remove("open",d)});l.listen("close",d);a.push(()=>{l.remove("close",d)});l.listen("error",d);a.push(()=>{l.remove("error",d)});return()=>{for(let e of a)e()}}rtcReset(){clearTimeout(this.rtcLoop);
this.rtcEvcancel();l&&l.clear()}getResponse(){return this.stream.getResponse()}static rtc(){l||(l=new O(P),l.init());return l}}class ja{constructor(a){this.data=a}parse(a=0){const b=this.data;let c=8;var d=b.getUint32(c);const e=d>>>24;d&=16777215;c+=4;const f=b.getUint32(c);c+=4;const g=b.getUint32(c);c+=4;let h,k;0==e?(h=b.getUint32(c),c+=4,k=b.getUint32(c),c+=4):(h=Number(b.getBigUint64(c)),c+=8,k=Number(b.getBigUint64(c)),c+=8);k+=a+1;c+=2;a=b.getUint16(c);c+=2;const m=[];let u=h,p=k;for(let w=
0;w<a;w++){const z=b.getUint32(c);c+=4;const D=b.getUint32(c);c+=4;c+=4;m.push({reference_type:0,reference_size:z,subsegment_duration:D,durationSec:D/g,startTimeSec:u/g,startRange:p,endRange:p+z-1});p+=z;u+=D}return{version:e,flag:d,referenceId:f,timeScale:g,earliest_presentation_time:h,first_offset:k,reference_count:a,references:m}}}class Q{static info(a){return this.types[a]?this.types[a]:["",""]}}Q.types={"1c53bb6b":["Cues","m"],bb:["CuePoint","m"],b3:["CueTime","u"],b7:["CueTrackPositions","m"],
f7:["CueTrack","u"],f1:["CueClusterPosition","u"]};class H{constructor(a){this.data=a;this.index=0}parse(){if(this.index<this.data.byteLength)return this.readVint()}readVint(){var a=this.read(1);a=H.vIntWidth(a)+1;const b=this.rewind(1).read(a),c=Q.info(b.toString(16));a=this.read(1);a=H.vIntWidth(a)+1;a=this.rewind(1).read(a);a=H.vIntNum(a);a=this.read(a,"u"==c[1]);return{id:b.toString(16),meta:c,data:a}}read(a,b=!0){var c=this.data.byteLength-this.index;a>c&&(a=c);if(!b)return b=new DataView(this.data.buffer,
this.data.byteOffset+this.index,a),this.index+=a,b;if(1==a)b=this.data.getUint8(this.index);else if(2==a)b=this.data.getUint16(this.index);else if(3==a)b=(this.data.getUint16(this.index)<<8)+this.data.getUint8(this.index+2);else if(4==a)b=this.data.getUint32(this.index);else if(5<=a&&7>=a){b=0;c=this.index;for(let d=0;d<a;d++)b*=256,b+=this.data.getUint8(c+d)}else b=8==a?Number(this.data.getBigUint64(this.index)):new DataView(this.data.buffer,this.data.byteOffset+this.index,a);this.index+=a;return b}rewind(a){this.index-=
a;return this}static vIntWidth(a){let b;for(b=0;8>b&&!(a>=2**(7-b));b++);return b}static vIntNum(a){let b=0;a>>(b^32)&&(b^=32);a>>(b^16)&&(b^=16);a>>(b^8)&&(b^=8);a>>(b^4)&&(b^=4);a>>(b^2)&&(b^=2);a>>(b^1)&&(b^=1);return a^1<<b}}class R{constructor(a){this.children=[];this.buffer=new H(a)}parseElements(){for(var a;a=this.buffer.parse();){const {id:b,meta:c,data:d}=a;a=this.parseElement(b,c,d);this.children.push(a)}return this.children}parseElement(a,b,c){const d=new R(c);d.id=a;[d.name,d.type]=b;
"m"==d.type?d.parseElements():d.value="u"==d.type?Number(c):c;return d}}class ka{constructor(a){this.data=a}parse(){return(new R(this.data)).parseElements()}}class la{constructor(a,b){this.parser=(this.isSidx=b)?new ja(a):new ka(a)}parse(a=0){return this.isSidx?this.getInfoSIDX(a):this.getInfoEBML()}getInfoSIDX(a){return this.parser.parse(a)}getInfoEBML(){const a=this.parser.parse(),b=[];a[0]&&a[0].children&&a[0].children.length&&a[0].children.forEach(c=>{if("bb"==c.id){const [d,e]=c.children;[,c]=
e.children;b.push({cueTime:d.value,cueClusterPosition:c.value})}});return b}}class ma{constructor(a,b,c,d){this.taskMap={};this.total=this.index=0;a=(new la(new DataView(a),!d)).parse(b);if(d){d={};b=b-a[0].cueClusterPosition+1;for(var e=0;e<a.length;e++)d[e]={m:a[e].cueClusterPosition+b,n:e<a.length-1?a[e+1].cueClusterPosition+b:c,no:e,begin:a[e].cueTime/1E3};this.taskMap=a=d}else{c={};for(b=0;b<a.reference_count;b++)d=a.references[b],e=b,c[e]={m:d.startRange,n:d.endRange+1,no:e,begin:d.startTimeSec};
this.taskMap=a=c}this.total=Object.keys(this.taskMap).length}next(a=10){const b=[];a=Math.min(this.index+a,this.total);let c=!0,d=this.index;for(let e=this.index;e<a;e++){const f=this.taskMap[e];f.done?c&&(d=f.no+1):(c=!1,b.push(f))}this.index=d;return b}getMap(){return this.taskMap}seekTo(a){if(a>=this.total)throw Error("index error");this.index=a}done(a){this.taskMap[a]?this.taskMap[a].done=!0:console.error("error in done")}}class na extends J{constructor(){super(...arguments);this.loaders=[]}async get(a,
b,c,d){return await (new J({req:a,start:Number(b),end:Number(c),thread:1,thunk:1048576,meta:a,mirrors:d,nop2p:!0})).start(!1).getResponse().arrayBuffer()}async attach(a,b){const c=new MediaSource;c.addEventListener("sourceopen",async()=>{try{const e=[],f=[],g=[],h=[];for(let k=0;k<b.length;k++){const {req:m,init:u,index:p,mimeCodec:w,len:z,meta:D,mirrors:K}=b[k];var d=z;let oa=/\.webm/.test(m);const [S,L]=await Promise.all([this.get(m,u.start,u.end+1,K),this.get(m,p.start,p.end+1,K)]);f.push([S,L]);
const y=new J({req:m,start:0,end:0,thread:this.config.thread,meta:D,mirrors:K,nop2p:this.config.nop2p});this.loaders.push(y);y.dispatcher=new ma(L,Number(p.end),Number(d),oa);const pa=y.dispatcher.getMap();e.push(pa);const qa=y.start(!0).getResponse().body.getReader();if("open"!==c.readyState)return;const C=new U(a,qa,c,w);y.refBuffer=C;g.push(()=>{y.pause(!1);C.push(S).push(L)});h.push(C.wait());C.listen("error",ra=>{this.trigger("error",ra);this.pause()});C.listen("pause",()=>{y.pause(!0)});C.listen("start",
()=>{y.pause(!1)})}this.trigger("ready",this.loaders,e,f);for(let k of g)k();await Promise.all(h)}catch(e){this.trigger("error",e),this.pause()}});c.addEventListener("sourceclosed",d=>{});c.addEventListener("sourceended",d=>{});this.video=a;this.mediaSource=c;a.src=URL.createObjectURL(c);this.timeUpdate=this.timeUpdate.bind(this);a.addEventListener("timeupdate",this.timeUpdate)}timeUpdate(){if(this.video.buffered.length){const a=this.video.currentTime;for(let b=0;b<this.video.buffered.length;b++){const c=
this.video.buffered.start(b),d=this.video.buffered.end(b);if(a>=c&&a<=d){600<d-a?this.pause():this.start();break}}}}start(){this.loaders.forEach(a=>a.pause(!1));return this}pause(){this.loaders.forEach(a=>a.pause(!0));return this}async destroy(){this.video.removeEventListener("timeupdate",this.timeUpdate);window.URL.revokeObjectURL(this.video.src);this.loaders.forEach(b=>b.destroy());this.loaders=[];let a=0;for(;5>a++;)if("open"===this.mediaSource.readyState){const b=[];for(let c of this.mediaSource.activeSourceBuffers)b.push(c.updating);
if(b.every(c=>!c))return this.mediaSource.endOfStream();await q(20)}this.mediaSource=null}seekTo(a){this.loaders.forEach(b=>b.seekTo(a))}async save(a){const b=await this.getResponse().blob();if(window.navigator.msSaveOrOpenBlob)return navigator.msSaveBlob(b,a);const c=document.createElement("a");c.style.display="none";c.href=window.URL.createObjectURL(b);c.download=a;document.body.appendChild(c);c.click();setTimeout(function(){document.body.removeChild(c);window.URL.revokeObjectURL(c.href)},200)}}
return na});
