'use strict';(function(l,g){"object"===typeof exports&&"undefined"!==typeof module?module.exports=g():"function"===typeof define&&define.amd?define(g):(l=l||self,l.fastloadjs=g())})(this,function(){class l{constructor(){this.events=new Map}register(a,b){this.events.has(a)?this.events.get(a).push(b):this.events.set(a,[b])}trigger(a,...b){(a=this.events.get(a))&&0!==a.length&&a.forEach(a=>setTimeout(()=>a.apply(null,b),0))}removeEvent(a,b){(a=this.events.get(a))&&0!==a.length&&a.splice(a.indexOf(b),
1)}removeAllEvents(a){if(a){if(!this.events.has(a))return!1;a=this.events.get(a);return 0<a.splice(0,a.length).length}this.events.clear()}}const g=async a=>new Promise(b=>{setTimeout(b,a)});class r{constructor(a){this.tasks=a;this.run()}push(a){this.tasks.push(a);this.run()}clear(){this.tasks=[]}async run(){if(!this.runing){this.runing=!0;for(var a;a=this.tasks.shift();)try{await a()}catch(b){}this.runing=!1}}}class D extends l{constructor(a,b,c,d){super();this.video=a;this.mediaSource=c;this.q=new r([]);
this.done=!1;a=c.addSourceBuffer(d);let e=!1;a.addEventListener("updateend",async a=>{if(!e)try{const {value:a,done:c}=await b.read();a&&this.push(a);c&&(setTimeout(()=>{this.q.push(()=>new Promise(async a=>{this.done=!0;a()}))},200),e=!0)}catch(h){this.trigger("error",h)}});a.addEventListener("abort",a=>{console.info(a)});a.addEventListener("error",a=>{console.info(a)});this.sourceBuffer=a}wait(){return new Promise(async a=>{for(;;){if(this.done&&this.update||"open"!==this.mediaSource.readyState)return a();
await g(500)}})}get update(){if("open"===this.mediaSource.readyState)return!this.sourceBuffer.updating;console.info("mediaSource.readyState status "+this.mediaSource.readyState);this.q.clear();this.trigger("pause");this.done=!0;return!1}push(a){this.q.push(()=>new Promise(async(b,c)=>{for(;;)try{if(this.done)break;if(this.update){try{this.sourceBuffer.appendBuffer(a)}catch(d){if("QuotaExceededError"!==d.name)throw d;this.trigger("pause");this.sourceBuffer.remove(0,this.video.currentTime-1);await g(80);
continue}return b()}await g(10)}catch(d){return this.trigger("error",d),c(d)}}));return this}}class t{constructor(a,b,c){this.taskMap={};this.index=0;if(!isFinite(b)||!isFinite(c)||b>c)throw Error("invalid start or end");let d=0;var e=b;for(b=!1;;){let f=e+a;f>c&&(f=c,b=!0);if(e>=f)break;this.taskMap[d]={m:e,n:f,no:d};if(b)break;e=f;d++}}get total(){return Object.keys(this.taskMap).length}last(a){if(a.no>=this.total-1)return!0}next(){var a=this.taskMap[this.index];if(a&&!a.done)return this.index++,
a;for(a=this.index;a<this.total;a++){var b=this.taskMap[a];if(!b.done)return b}for(a=0;a<this.total;a++)if(b=this.taskMap[a],!b.done)return b}getMap(){return this.taskMap}seekTo(a){if(a>=this.total)throw Error("index error");this.index=a}done(a){this.taskMap[a]?this.taskMap[a].done=!0:console.error("error in done")}}class u{constructor(a,b){this.init=a;this.order=b;this.index=0;this.dataMap={};this.dataMapArray=[];const c=this,d=async a=>{const {data:b,done:d,err:e}=await c.get();e?a.error(e):(b&&
a.enqueue(new Uint8Array(b)),d&&a.close())};this.stream=new ReadableStream({async start(a){await d(a)},async pull(a){await d(a)}})}async get(){for(;;){if(this.destroyed)return{done:!0};let a;if(a=this.order?this.dataMap[this.index]:this.dataMapArray[this.index])return this.index++,a;await g(1E3)}}destroy(){this.destroyed=!0}item(a){return this.dataMap[a]}push(a,b){this.dataMap[a]=b;this.dataMapArray.push(b)}getResponse(){return new Response(this.stream,this.init)}}class v{constructor(a,b,c,d){this.threadNum=
a;this.retry=b;this.callback=c;this.finish=d;this.t=0;this.tasks=[];this.pause=!1}async thread(a){for(a=!1;;){if(this.pause){await this.sleep(100);continue}const b=this.get();b?(a=await this.do(b),a=await this.taskOneDone(a)):await this.sleep(100);if(a)break}this.taskDone()}push(a){this.tasks.push(a);this.t<this.threadNum&&(this.thread(this.t),this.t++)}get(){return this.tasks.pop()}async taskOneDone(a){return await this.callback(a)}taskDone(){this.t--;0>=this.t&&this.finish()}async sleep(a){return await new Promise(b=>
{setTimeout(b,a)})}async do(a){const b=this.retry;let c={};for(let d=0;d<b;d++)try{c=await a();break}catch(e){console.error(e)}return c}}const w=(a,b,c)=>{a=a.toString().replace(/\.(mp4|webm)/,`/${b}-${c-1}.ts`);return new Request(a,{method:"GET"})};class x{constructor(a){this.requestBuilder=a?a:this.buildRequest}async fetch(a,b,c,d){a=this.requestBuilder(a,b,c);return await this.send(a,d)}build(a,b){return 0>=a&&0>=b?{method:"GET"}:{method:"GET",headers:{Range:`bytes=${a?a:0}-${b?b-1:""}`}}}buildRequest(a,
b,c){b=this.build(b,c);return new Request(a,b)}async send(a,b){const c=new Promise((a,c)=>{setTimeout(()=>{c("timeout")},b.timeout)});a=fetch(a,{cache:!1===b.cache?"reload":"force-cache"});return await Promise.race([a,c])}}class y{static async get(a,b,c,d){this.fetchInstance||(this.fetchInstance=new x(w));return await this.fetchInstance.fetch(a,b,c,d)}static async fetch(a,b,c,d){a=await this.get(a,b,c,d);return this.parse(a)}static async parse(a){try{if(![200,206,304].includes(a.status))throw Error(a.statusText);
return{no:null,data:await a.arrayBuffer(),err:null}}catch(b){return{no:null,err:b,data:null}}}}class E{constructor(){}static wrap(a,b,c,d,e){return async()=>{let f;const h=d-c;let m={timeout:15E3,cache:!0};for(let k=0;k<a;k++)try{f=await y.fetch(b,c,d,m);f.no=e;f.err=null;const a=f.data?f.data.byteLength:-1;if(a!==h)throw Error(`short read error:expect ${h},got ${a}`);break}catch(A){m.cache=!1,console.error(A,k,b,c,d,e),f={no:e,err:A,data:null},await new Promise(a=>{setTimeout(a,1E3)})}return f}}}
class z extends l{constructor(a){super();this.defaultOpts={retry:3,thread:2,thunk:524288};this.config=Object.assign({},this.defaultOpts,a)}start(a){const {thread:b,thunk:c,start:d,end:e,retry:f}=this.config;this.dispatcher||(this.dispatcher=new t(c,Number(d),Number(e)));this.stream=new u(null,!1);this.worker=new v(b,f,a=>this.taskDone(a),()=>{this.taskFinish()});this.worker.pause=a;for(a=0;a<b;){const b=this.dispatcher.next();b&&this.worker.push(this.taskWrap(b));a++}return this}pause(a){this.worker.pause=
a}destroy(){this.removeAllEvents();this.pause(!0);this.stream.destroy();this.stream=null;this.refBuffer&&(this.refBuffer.q.clear(),this.refBuffer=null)}seekTo(a){this.pause(!1);const b=this.dispatcher.getMap(),c=this.dispatcher.total;for(let d=0;d<c;d++)if(b[d].begin>=a){a=Math.max(d-1,0);this.dispatcher.seekTo(a);this.cachefill(a);break}}cachefill(a){const b=this.dispatcher.total;let c=!1;for(;a<b;a++){const b=this.stream.item(a);if(!b||b.err||!b.data)break;c||(this.refBuffer.q.clear(),c=!0);this.refBuffer.push(b.data)}}taskWrap(a){const {m:b,
n:c,no:d}=a;a=this.getBestURL();return E.wrap(this.config.retry,a,b,c,d)}getBestURL(){return this.config.req}taskDone(a){if(!this.stream)return!0;this.stream.push(a.no,a);this.dispatcher.done(a.no);setTimeout(()=>{this.trigger("res.done",a)},200);if(a.err)return this.err=a.err,!0;if(this.err)return!0;const b=this.dispatcher.next();if(b)this.worker.push(this.taskWrap(b)),this.trigger("res.start",b);else return!0}taskFinish(){this.stream&&this.stream.push(this.dispatcher.total,{done:!0})}getResponse(){return this.stream.getResponse()}}
class F{constructor(a){this.data=new DataView(a);this.size=this.data.byteLength;this.byte=0}readVInt(a=!1){var b=this.data.getUint8(this.byte);if(0==b)throw"Variable int is too large to parse";for(var c=0;8>c&&!(b>=Math.pow(2,7-c));c++);if(this.byte+c+1>this.size)throw"Missing bytes, not enough data to parse variable int";a||(b-=Math.pow(2,7-c));for(a=1;a<=c;a++)b*=Math.pow(2,8),b+=this.data.getUint8(this.byte+a);this.byte+=c+1;return b}readUInt(a){for(var b=0,c=0;c<a;c++)b*=Math.pow(2,8),b+=this.data.getUint8(this.byte+
c);this.byte+=a;return b}}class q{constructor(){this.size=this.start=this.id=0;this.value=this.meta=null;this.children=[]}setMeta(a){this.meta=a.type(this.id)}get name(){return this.meta.name}parseElements(a,b){let c=this.start+this.size;for(;a.byte<c;)this.children.push(this.parseElement(a,b))}parseElement(a,b){let c=new q;c.start=a.byte;c.id=a.readVInt(!0);c.size=a.readVInt();c.setMeta(b);c.meta.container?c.parseElements(a,b):c.value=a.readUInt(c.size);return c}}class G{constructor(){this.schema=
{};this.add(475249515,"Cues","master");this.add(187,"CuePoint","master");this.add(179,"CueTime","uinteger");this.add(183,"CueTrackPositions","master");this.add(247,"CueTrack","uinteger");this.add(241,"CueClusterPosition","uinteger")}add(a,b,c){b={name:b,dataType:c,container:!1};"master"==c&&(b.container=!0);this.schema[a]=b}type(a){return this.schema[a]}}class H{constructor(a){this.schema=new G;a=new F(a);this.root=new q;this.root.start=0;this.root.size=a.size;this.root.parseElements(a,this.schema)}get elements(){return this.root.children}get stat(){var a=
this.elements[0];const b=[];if(a.children){for(let c of a.children){const [d,e]=c.children;a=d.value;const [,f]=e.children;b.push({t:a,o:f.value})}return b}}info(a,b){const c=this.stat,d=[];a=a.end-c[0].o+1;for(let e=0;e<c.length;e++)d.push({start:c[e].o+a,end:e<c.length-1?c[e+1].o+a-1:b-1,startTime:c[e].t,duration:e<c.length-1?c[e+1].t-c[e].t:c[e].t+6E3});return d}}class I{constructor(a){this.buffer=a;this.data=new DataView(a)}parse(a){let b=0;const c=this.data.getUint8(b+8);b+=12;const d=this.data.getUint32(b+
4);b+=8;let e,f;0===c?(e=this.data.getUint32(b),f=this.data.getUint32(b+4),b+=8):(e=2**32*this.data.getUint32(b)+this.data.getUint32(b+4),f=(this.data.getUint32(b+8)<<32)+this.data.getUint32(b+12),b+=16);f+=a||this.data.byteLength;a=this.data.getUint16(b+2);b+=4;const h=[];let m=f,k=e;for(let c=0;c<a;c++){let a=this.data.getUint32(b);const c=a>>>31;a&=2147483647;const e=this.data.getUint32(b+4),f=m+a-1,g=m,l=g+"-"+f;b+=12;h.push({size:a,type:c,offset:m,duration:e,time:k,timescale:d,mediaRange:l,startRange:g,
endRange:f,durationSec:e/d,startTimeSec:k/d});m+=a;k+=e}return{version:c,timescale:d,earliestPresentationTime:e,firstOffset:f,referenceCount:a,references:h}}parseWebM(a){const {index:b,len:c}=a;return(new H(this.buffer)).info(b,c)}}class J{constructor(a,b,c,d){this.taskMap={};this.index=0;a=new I(a);if(d)for(b=a.parseWebM(c),c=0;c<b.length;c++)d=b[c],a=c,this.taskMap[a]={m:d.start,n:d.end+1,no:a,begin:d.startTime/1E3};else for(b=a.parse(b),c=0;c<b.referenceCount;c++)d=b.references[c],a=c,this.taskMap[a]=
{m:d.startRange,n:d.endRange+1,no:a,begin:d.startTimeSec}}get total(){return Object.keys(this.taskMap).length}last(a){if(a.no>=this.total-1)return!0}next(){var a=this.taskMap[this.index];if(a&&!a.done)return this.index++,a;for(a=this.index;a<this.total;a++){var b=this.taskMap[a];if(!b.done)return b}for(a=0;a<this.total;a++)if(b=this.taskMap[a],!b.done)return b}getMap(){return this.taskMap}seekTo(a){if(a>=this.total)throw Error("index error");this.index=a}done(a){this.taskMap[a]?this.taskMap[a].done=
!0:console.error("error in done")}}class K extends z{constructor(){super(...arguments);this.loaders=[]}async get(a,b,c){return await (new z({req:a,start:Number(b),end:Number(c),thread:1,thunk:1048576})).start(!1).getResponse().arrayBuffer()}async attach(a,b){const c=new MediaSource;c.addEventListener("sourceopen",async()=>{try{const d=[],e=[],f=[],g=[];for(let m=0;m<b.length;m++){const {req:k,init:l,index:h,mimeCodec:q,len:r,duration:t}=b[m];let u={index:h,len:r,duration:t},v=/\.webm/.test(k);const B=
await Promise.all([this.get(k,l.start,l.end+1),this.get(k,h.start,h.end+1)]),[w,C]=B;e.push(B);const n=new z({req:k,start:0,end:0,thread:this.config.thread});this.loaders.push(n);n.dispatcher=new J(C,Number(h.end)+1,u,v);const x=n.dispatcher.getMap();d.push(x);const y=n.start(!0).getResponse().body.getReader();if("open"!==c.readyState)return;const p=new D(a,y,c,q);n.refBuffer=p;f.push(()=>{n.pause(!1);p.push(w).push(C)});g.push(p.wait());p.register("error",a=>{this.trigger("error",a);this.pause()});
p.register("pause",()=>{n.pause(!0)});p.register("start",()=>{n.pause(!1)})}this.trigger("ready",this.loaders,d,e);for(let a of f)a();await Promise.all(g)}catch(d){this.trigger("error",d),this.pause()}});c.addEventListener("sourceclosed",a=>{});c.addEventListener("sourceended",a=>{});this.video=a;this.mediaSource=c;a.src=URL.createObjectURL(c);this.timeUpdate=this.timeUpdate.bind(this);a.addEventListener("timeupdate",this.timeUpdate)}timeUpdate(){if(this.video.buffered.length){const a=this.video.currentTime;
for(let b=0;b<this.video.buffered.length;b++){const c=this.video.buffered.start(b),d=this.video.buffered.end(b);a>=c&&a<=d&&(600<d-a?this.pause():this.start())}}}start(){this.loaders.forEach(a=>a.pause(!1));return this}pause(){this.loaders.forEach(a=>a.pause(!0));return this}async destroy(){this.video.removeEventListener("timeupdate",this.timeUpdate);window.URL.revokeObjectURL(this.video.src);this.loaders.forEach(a=>a.destroy());this.loaders=[];let a=0;for(;5>a++;)if("open"===this.mediaSource.readyState){const a=
[];for(let b of this.mediaSource.activeSourceBuffers)a.push(b.updating);if(a.every(a=>!a))return this.mediaSource.endOfStream();await g(20)}this.mediaSource=null}seekTo(a){this.loaders.forEach(b=>b.seekTo(a))}async save(a){const b=await this.getResponse().blob();if(window.navigator.msSaveOrOpenBlob)return navigator.msSaveBlob(b,a);const c=document.createElement("a");c.style.display="none";c.href=window.URL.createObjectURL(b);c.download=a;document.body.appendChild(c);c.click();setTimeout(function(){document.body.removeChild(c);
window.URL.revokeObjectURL(c.href)},200)}}return K});
