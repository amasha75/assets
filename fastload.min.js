'use strict';(function(v,k){"object"===typeof exports&&"undefined"!==typeof module?module.exports=k():"function"===typeof define&&define.amd?define(k):(v=v||self,v.fastloadjs=k())})(this,function(){class v{constructor(){this.events=new Map}register(a,b){this.events.has(a)?this.events.get(a).push(b):this.events.set(a,[b])}trigger(a,...b){(a=this.events.get(a))&&0!==a.length&&a.forEach(a=>setTimeout(()=>a.apply(null,b),0))}removeEvent(a,b){(a=this.events.get(a))&&0!==a.length&&a.splice(a.indexOf(b),
1)}removeAllEvents(a){if(a){if(!this.events.has(a))return!1;a=this.events.get(a);return 0<a.splice(0,a.length).length}this.events.clear()}}const k=async a=>new Promise(b=>{setTimeout(b,a)});class H{constructor(a){this.tasks=a;this.run()}push(a){this.tasks.push(a);this.run()}clear(){this.tasks=[]}async run(){if(!this.runing){this.runing=!0;for(var a;a=this.tasks.shift();)try{await a()}catch(b){}this.runing=!1}}}class I extends v{constructor(a,b,c,d){super();this.video=a;this.mediaSource=c;this.q=new H([]);
this.done=!1;a=c.addSourceBuffer(d);let e=!1;a.addEventListener("updateend",async a=>{if(!e)try{const {value:a,done:c}=await b.read();a&&this.push(a);c&&(setTimeout(()=>{this.q.push(()=>new Promise(async a=>{this.done=!0;a()}))},200),e=!0)}catch(h){this.trigger("error",h)}});a.addEventListener("abort",a=>{console.info(a)});a.addEventListener("error",a=>{console.error(a)});this.sourceBuffer=a}wait(){return new Promise(async a=>{for(;;){if(this.done&&this.update||"open"!==this.mediaSource.readyState)return a();
await k(500)}})}get update(){if("open"===this.mediaSource.readyState)return!this.sourceBuffer.updating;console.info("mediaSource.readyState status "+this.mediaSource.readyState);this.q.clear();this.trigger("pause");this.done=!0;return!1}push(a){this.q.push(()=>new Promise(async(b,c)=>{for(;;)try{if(this.done)break;if(this.update){try{this.sourceBuffer.appendBuffer(a)}catch(d){if("QuotaExceededError"!==d.name)throw d;this.trigger("pause");this.sourceBuffer.remove(0,this.video.currentTime-1);await k(80);
continue}return b()}await k(10)}catch(d){return this.trigger("error",d),c(d)}}));return this}}class J{constructor(a,b,c){this.taskMap={};this.index=0;if(!isFinite(b)||!isFinite(c)||b>c)throw Error("invalid start or end");let d=0;var e=b;for(b=!1;;){let f=e+a;f>c&&(f=c,b=!0);if(e>=f)break;this.taskMap[d]={m:e,n:f,no:d};if(b)break;e=f;d++}}get total(){return Object.keys(this.taskMap).length}next(){var a=this.taskMap[this.index];if(a&&!a.done&&!a.start)return this.index++,a.start=!0,a;for(a=this.index;a<
this.total;a++){var b=this.taskMap[a];if(!b.done)return b.start=!0,b}for(a=0;a<this.total;a++)if(b=this.taskMap[a],!b.done)return b.start=!0,b}rtcNext(){for(let a=this.index;a<this.total;a++){const b=this.taskMap[a];if(!b.done&&!b.start)return b.start=!0,b}}getMap(){return this.taskMap}seekTo(a){if(a>=this.total)throw Error("index error");this.index=a}done(a){this.taskMap[a]?this.taskMap[a].done=!0:console.error("error in done")}}class K{constructor(a,b){this.init=a;this.order=b;this.index=0;this.dataMap=
{};this.dataMapArray=[];const c=this,d=async a=>{const {data:b,done:d,err:e}=await c.get();e?a.error(e):(b&&a.enqueue(new Uint8Array(b)),d&&a.close())};this.stream=new ReadableStream({async start(a){await d(a)},async pull(a){await d(a)}})}async get(){for(;;){if(this.destroyed)return{done:!0};let a;if(a=this.order?this.dataMap[this.index]:this.dataMapArray[this.index])return this.index++,a;await k(1E3)}}destroy(){this.destroyed=!0}item(a){return this.dataMap[a]}push(a,b){this.dataMap[a]=b;this.dataMapArray.push(b)}getResponse(){return new Response(this.stream,
this.init)}}class L{constructor(a,b,c,d){this.threadNum=a;this.retry=b;this.callback=c;this.finish=d;this.t=0;this.tasks=[];this.pause=!1}async thread(a){for(a=!1;;)if(this.pause)await k(100);else{var b=this.get();if(b)b=await this.do(b),await this.taskOneDone(b)&&(a=!0);else if(await k(100),a)break}this.taskDone()}push(a){this.tasks.push(a);this.t<this.threadNum&&(this.thread(this.t),this.t++)}get(){return this.tasks.pop()}async taskOneDone(a){return await this.callback(a)}taskDone(){this.t--;0>=
this.t&&this.finish()}async do(a){const b=this.retry;let c={};for(let d=0;d<b;d++)try{c=await a();break}catch(e){console.error(e)}return c}}const M=(a,b,c)=>{a=a.toString().replace(/\.(mp4|webm)/,`/${b}-${c-1}.ts`);return new Request(a,{method:"GET"})};class N{constructor(a){this.requestBuilder=a?a:this.buildRequest}async fetch(a,b,c,d){a=this.requestBuilder(a,b,c);return await this.send(a,d)}build(a,b){return 0>=a&&0>=b?{method:"GET"}:{method:"GET",headers:{Range:`bytes=${a?a:0}-${b?b-1:""}`}}}buildRequest(a,
b,c){b=this.build(b,c);return new Request(a,b)}async send(a,b){const c=new Promise((a,c)=>{setTimeout(()=>{c("timeout")},b.timeout)});a=fetch(a,{cache:!1===b.cache?"reload":"force-cache"});return await Promise.race([a,c])}}class O{static async get(a,b,c,d){this.fetchInstance||(this.fetchInstance=new N(M));return await this.fetchInstance.fetch(a,b,c,d)}static async fetch(a,b,c,d){a=await this.get(a,b,c,d);return this.parse(a)}static async parse(a){try{if(![200,206,304].includes(a.status))throw Error(a.statusText);
return{no:null,data:await a.arrayBuffer(),err:null}}catch(b){return{no:null,err:b,data:null}}}}class P{constructor(){}static wrap(a,b,c,d,e){return async()=>{let f;const h=d-c;let m={timeout:15E3,cache:!0};for(let u=0;u<a;u++)try{f=await O.fetch(b,c,d,m);f.no=e;f.err=null;const a=f.data?f.data.byteLength:-1;if(a!==h)throw Error(`short read error:expect ${h},got ${a}`);break}catch(p){m.cache=!1,console.error(p,u,b,c,d,e),f={no:e,err:p,data:null},await new Promise(a=>{setTimeout(a,1E3)})}return f}}}
class Q{constructor(a){this.addr=a;this.$ws=null;this.tasks=[];this.runing=!1;this.clientList=new Map;this.connect()}connect(){!this.$ws||this.$ws.readyState!=this.$ws.OPEN&&this.$ws.readyState!=this.$ws.CONNECTING?(this.$ws=new WebSocket(this.addr),this.$ws.binaryType="arraybuffer",this.$ws.onopen=a=>{this.trigger("open",a);this.stopconnect();this.notify()},this.$ws.onmessage=a=>{try{if(a.data){const b=JSON.parse(a.data);this.trigger("message",b)}}catch(b){console.error(b)}},this.$ws.onclose=a=>
{this.trigger("close",a);this.startconnect()},this.$ws.onerror=a=>{this.trigger("error",a);this.startconnect()}):this.stopconnect()}startconnect(){clearInterval(this.timer);this.timer=setInterval(()=>{!1!==window.navigator.onLine&&this.connect()},2E3)}stopconnect(){clearInterval(this.timer)}notify(){if(!this.runing){this.runing=!0;if(this.$ws&&this.$ws.readyState==this.$ws.OPEN){let a;for(;a=this.tasks.shift();)this.$ws.send(a)}else this.startconnect();this.runing=!1}}sendJson(a){try{const b=JSON.stringify(a);
b&&(this.tasks.push(b),this.notify())}catch(b){console.error(b)}return this}trigger(a,b){if((a=this.clientList.get(a))&&0!==a.length)for(let c of a)c(b)}listen(a,b){const c=this.clientList.get(a);if(!c)return this.clientList.set(a,[b]),this;for(a=c.length-1;0<=a;a--)if(c[a]===b)return this;c.push(b);return this}remove(a,b){a=this.clientList.get(a);if(!a)return this;if(b)for(let c=a.length-1;0<=c;c--)a[c]===b&&a.splice(c,1);else a.length=0;return this}}class q{constructor(a){this.clientList=new Map;
q.ws||(q.ws=new Q(a),q.ws.listen("open",()=>{q.ev&&q.ws.sendJson({listen:!0,event:q.ev})}),q.ws.listen("message",a=>{const {ev:b,data:d}=q.dispatch(a);this.trigger(b,d)}))}static getWs(a,b,c){this.single||(this.ev=c,this.dispatch=b,this.single=new this(a));""===c?(this.ev&&this.ws.sendJson({listen:!1,event:this.ev}),this.ev=c):c&&c!==this.ev&&(this.ev&&this.ws.sendJson({listen:!1,event:this.ev}),this.ws.sendJson({listen:!0,event:c}),this.ev=c);return this.single}trigger(a,b){if((a=this.clientList.get(a))&&
0!==a.length)for(let c of a)c(b)}listen(a,b){const c=this.clientList.get(a);if(!c)return this.clientList.set(a,[b]),this;for(a=c.length-1;0<=a;a--)if(c[a]===b)return this;c.push(b);return this}remove(a,b){a=this.clientList.get(a);if(!a)return this;if(b)for(let c=a.length-1;0<=c;c--)a[c]===b&&a.splice(c,1);else a.length=0;return this}sendJson(a){q.ws.sendJson(a);return this}}const R=localStorage.getItem("ws")||"ws://127.0.0.1:9090/channel/json/uid/";let t="";const y=a=>{let b="";b=a?`rtc:${a}`:a;a=
R+w();return q.getWs(a,a=>({ev:`${a.event}`,data:a}),b)},w=()=>{if(t)return t;t=sessionStorage.getItem("uid");if(!t||36!=t.length){var a=function(){return(65536*(1+Math.random())|0).toString(36)};t=a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a();sessionStorage.setItem("uid",t)}return t},B=sessionStorage.getItem("loglevel")||"log",r=["warn","info","log"].includes(B)?console.warn.bind(console):()=>{},z=["info","log"].includes(B)?console.info.bind(console):()=>{},n=["log"].includes(B)?console.log.bind(console):
()=>{},C=(a,b)=>{if(!a)return b;if(!b)return a;const c=new Uint8Array(a.byteLength+b.byteLength);c.set(new Uint8Array(a),0);c.set(new Uint8Array(b),a.byteLength);return c.buffer};class D{constructor(){this.events=new Map}register(a,b){this.events.has(a)?this.events.get(a).push(b):this.events.set(a,[b])}trigger(a,...b){(a=this.events.get(a))&&0!==a.length&&a.forEach(a=>setTimeout(()=>a.apply(null,b),0))}removeEvent(a,b){(a=this.events.get(a))&&0!==a.length&&a.splice(a.indexOf(b),1)}removeAllEvents(a){if(a){if(!this.events.has(a))return!1;
a=this.events.get(a);return 0<a.splice(0,a.length).length}this.events.clear()}}class S{constructor(a,b,c){this.id=a;this.servers=b;this.onmsg=c;this.rx=this.tx=0;this.init()}init(){this.c=new RTCPeerConnection(this.servers);this.c.onnegotiationneeded=async a=>{n(a);try{const a=await this.c.createOffer();await this.c.setLocalDescription(a);y().sendJson({event:"offer",to:this.id,from:w(),data:a});n(a)}catch(b){console.error(b)}};this.c.ondatachannel=a=>{this.dc=a.channel;this.dc.binaryType="arraybuffer";
this.dcInit();n(a)};this.c.onconnectionstatechange=a=>{n(a)};this.c.onicecandidateerror=a=>{n(a)};this.c.onicegatheringstatechange=a=>{n(a)};this.c.oniceconnectionstatechange=a=>{n(a)};this.c.onicecandidate=a=>{n(a);a.candidate&&(a={event:"candidate",from:w(),to:this.id,data:a.candidate},y().sendJson(a),n("send candidate",a))}}async connect(){n("i connect ",this.id);this.dc&&"open"==this.dc.readyState?z("connection to ",this.id," is already open"):(this.init(),this.dc=this.c.createDataChannel("dc"),
this.dc.binaryType="arraybuffer",this.dcInit())}dcInit(){window.addEventListener("beforeunload",()=>{this.c.close();this.dc.close()});this.dc.onopen=a=>{r("dc open me : "+w()+" remote: "+this.id,a);this.onmsg("open",a)};this.dc.onclose=a=>{r("dc close "+this.id,a);this.onmsg("close",a)};this.dc.onerror=a=>{r("dc error "+this.id,a);this.onmsg("error",a)};this.dc.addEventListener("closing",a=>{r("dc closing "+this.id,a);this.onmsg("closing",a)});this.dc.onmessage=async a=>{let b=a.data;b instanceof
Blob&&(b=await a.data.arrayBuffer());this.rx=b instanceof ArrayBuffer?this.rx+b.byteLength:this.rx+b.length;this.onmsg("message",{data:b})}}async onOffer(a){"closed"==this.c.signalingState?r("onOffer error signalingState is closed"):(await this.c.setRemoteDescription(a),a=await this.c.createAnswer(),await this.c.setLocalDescription(a),a={event:"answer",from:w(),to:this.id,data:a},n("send answer",a),y().sendJson(a))}async onAnswer(a){["closed"].includes(this.c.signalingState)?r("onAnswer error signalingState is "+
this.c.signalingState):(await this.c.setRemoteDescription(a),z("setRemoteDescription",a))}async onCandidate(a){["closed"].includes(this.c.signalingState)?r("onCandidate error signalingState is "+this.c.signalingState):(this.c.addIceCandidate(a),z("made connection ",this.id))}send(a){if(this.dc)if("open"!==this.dc.readyState)r("data channel to "+this.id+" is not open");else{var b=this.dc.send(a);this.tx=a instanceof ArrayBuffer?this.tx+a.byteLength:this.tx+a.length;return b}else r("data channel to "+
this.id+" is not avaiable")}stat(){return{tx:this.tx,rx:this.rx,state:this.dc?this.dc.readyState:""}}}class F{constructor(a,b,c,d){this.id=a;this.passive=b;this.servers=c;this.state=2;this.conn=new S(a,c,(a,b)=>{"message"==a?d("message",b):(this.state="open"==a?0:1,d(a,b))})}connect(){this.passive=!1;this.conn.connect()}waitForConnect(){this.passive=!0}onOffer(a){this.conn.onOffer(a)}onAnswer(a){this.conn.onAnswer(a)}onCandidate(a){this.conn.onCandidate(a)}send(a){return this.conn.send(a)}stat(){return this.conn.stat()}}
const l=new Map;class T extends D{constructor(a){super();this.servers=a}createPassive(a){const b=new F(a,!0,this.servers,(b,d)=>{this.trigger(b,{uid:a,e:d})});l.set(a,b);b.waitForConnect()}createPositive(a){const b=new F(a,!1,this.servers,(b,d)=>{this.trigger(b,{uid:a,e:d})});l.set(a,b);b.connect()}ensureWaitIds(a){a.forEach(a=>{l.has(a)?l.get(a).waitForConnect():this.createPassive(a)})}ensureToConnect(a){l.has(a)?l.get(a).connect():this.createPositive(a)}async onOffer(a,b){if(a=l.get(a))a.onOffer(b);
else console.error("onOffer peer not found error")}async onAnswer(a,b){if(a=l.get(a))a.onAnswer(b);else console.error("onAnswer peer not found error")}async onCandidate(a,b){if(a=l.get(a))a.onCandidate(b);else console.error("onCandidate peer not found error")}sendTo(a,b){const c=l.get(a);if(c)return c.send(b);console.error("uuid "+a+" not connected")}broadcast(a){l.forEach(b=>{b.send(a)})}getPeers(){return l.keys()}getStats(){const a={};l.forEach(b=>{a[b.id]=b.stat()});return a}}class U extends D{constructor(a){super();
this.servers=a;this.buffers=new Map;this.m=new T(a);this.m.register("message",a=>{const b=a.e.data;if(b instanceof ArrayBuffer)return this.extract(b,a.uid);this.trigger("message",a)});this.m.register("open",a=>this.trigger("open",a));this.m.register("close",a=>this.trigger("close",a));this.m.register("error",a=>this.trigger("error",a));this.id=w()}extract(a,b){try{let p=String.fromCharCode.apply(null,new Uint16Array(a.slice(0,60))).trim();if(/^[!-~]+$/.test(p)){var c=a.slice(60),[d,e,f]=JSON.parse(p),
h=this.buffers.get(d);h?h[e]=c:(a=[],a[e]=c,this.buffers.set(d,a));this.trigger("buffer.recv",{id:d,buffer:c,i:e,n:f,uid:b});c=!0;var m=this.buffers.get(d);for(a=0;a<f;a++)m[a]||(c=!1);if(c){var u=m[0];for(c=1;c<f;c++)u=C(u,m[c]);this.trigger("buffer",{id:d,buffer:u,uid:b});this.buffers.delete(d)}}else this.trigger("message.buffer",{data:a,uid:b})}catch(p){console.error(p)}}init(){y().listen("offer",a=>{this.onOffer(a)}).listen("answer",a=>{this.onAnswer(a)}).listen("candidate",a=>{this.onCandidate(a)}).listen("online",
a=>{a.id!=this.id&&this.connectId(a.id)}).listen("init",a=>{this.waitForIds(a.ids)})}sendTo(a,b){return this.m.sendTo(a,b)}broadcast(a){return this.m.broadcast(a)}getPeers(){return this.m.getPeers()}getStats(){return this.m.getStats()}sendBuffer(a,b,c){this.splitBuffer(b,c).forEach(b=>{this.sendTo(a,b.data)})}broadcastBuffer(a,b){this.splitBuffer(a,b).forEach(a=>{this.broadcast(a.data)})}splitBuffer(a,b){let c=0,d=!1;const e=[],f=Math.ceil(a.byteLength/102400);for(;;){const l=102400*c;let k=102400*
(c+1);k>=a.byteLength&&(k=a.byteLength,d=!0);const n=a.slice(l,k);var h=JSON.stringify([b.substr(0,20),c,f]);var m=30-h.length;h=0<m?h+" ".repeat(m):h;m=new ArrayBuffer(2*h.length);for(var u=new Uint16Array(m),p=0,g=h.length;p<g;p++)u[p]=h.charCodeAt(p);e.push({start:l,end:k,i:c,data:C(m,n)});c++;if(d)return e}}onOffer(a){this.m.onOffer(a.from,a.data)}onAnswer(a){this.m.onAnswer(a.from,a.data)}onCandidate(a){this.m.onCandidate(a.from,a.data)}connectId(a){this.m.ensureToConnect(a)}waitForIds(a){this.m.ensureWaitIds(a)}}
class V extends U{constructor(a){super(a);this.refBuffers=new Map;this.founders=new Map;this.founderTimers={};this.queries=new Map;this.resolver=new Map;this.register("message",a=>{const b=a.uid;a=a.e.data;try{const {event:c,data:e}=JSON.parse(a);this.trigger(c,{data:e,uid:b})}catch(d){console.error(d)}});this.listen()}query(a,b,c){this.founders.set(`${a}:${b}`,[]);this.resolver.set(a,c);this.broadcast(JSON.stringify({event:"query",data:{id:a,index:b}}))}async found(a,b){var c=this.resolver.get(a);
if(c){var d=`${a}:${b}`;(c=await c(a,b))?(this.refBuffers.set(d,c),(c=this.queries.get(d))&&c.length&&(c.forEach(c=>{this.sendTo(c,JSON.stringify({event:"found",data:{id:a,index:b}}))}),this.queries.delete(d))):console.warn("resolve has no buffer for ",a,b)}else console.warn("no resolve found for ",a)}listen(){this.register("query",async({data:a,uid:b})=>{const {id:c,index:d}=a;a=`${c}:${d}`;const e=this.queries.get(a);e?e.push(b):this.queries.set(a,[b]);await this.found(c,d)});this.register("found",
({data:a,uid:b})=>{const {id:c,index:d}=a,e=`${c}:${d}`;let f=this.founders.get(e);console.info(b," has ",e);if(!f)return console.warn(e+" is already resolve");f.push(b);clearTimeout(this.founderTimers[e]);this.founderTimers[e]=setTimeout(async()=>{const a=this.resolver.get(c);a&&await a(c,d)||(this.sendTo(f[Math.floor(Math.random()*f.length)],JSON.stringify({event:"resolve",data:{id:c,index:d}})),this.founders.delete(e))},100)});this.register("resolve",async({data:a,uid:b})=>{const {id:c,index:d}=
a;return(a=this.refBuffers.get(`${c}:${d}`))?this.sendBuffer(b,a,`${c}|${d}`):console.error("unresolved",c,d)});this.register("buffer",({id:a,buffer:b})=>{let [c,d]=a.split("|");d=Number(d);this.trigger("data",{id:c,index:d,buffer:b})})}}const g=new V({});g.init();class E extends v{constructor(a){super();this.defaultOpts={retry:3,thread:2,thunk:524288};this.config=Object.assign({},this.defaultOpts,a)}start(a){const {thread:b,thunk:c,start:d,end:e,retry:f}=this.config;this.dispatcher||(this.dispatcher=
new J(c,Number(d),Number(e)));this.stream=new K(null,!1);this.worker=new L(b,f,a=>this.taskDone(a),()=>{this.taskFinish()});this.worker.pause=a;let h=0;for(;h<b;){const a=this.dispatcher.next();a&&this.worker.push(this.taskWrap(a));h++}this.rtcLoop||!1===a||this.config.meta==this.config.req||setTimeout(()=>this.rtcInit(),1E3);return this}pause(a){this.worker.pause=a}destroy(){this.removeAllEvents();this.pause(!0);this.stream.destroy();this.stream=null;this.refBuffer&&(this.refBuffer.q.clear(),this.refBuffer=
null)}seekTo(a){this.pause(!1);const b=this.dispatcher.getMap(),c=this.dispatcher.total;for(let d=0;d<c;d++)if(b[d].begin>=a){a=Math.max(d-1,0);this.dispatcher.seekTo(a);this.cachefill(a);break}}cachefill(a){const b=this.dispatcher.total;let c=!1;for(;a<b;a++){const b=this.stream.item(a);if(!b||b.err||!b.data)break;c||(this.refBuffer.q.clear(),c=!0);this.refBuffer.push(b.data)}}taskWrap(a){const {m:b,n:c,no:d}=a;a=this.getBestURL();return P.wrap(this.config.retry,a,b,c,d)}getBestURL(){return this.config.req}taskDone(a){if(!this.stream)return!0;
this.stream.item(a.no)||(this.stream.push(a.no,a),setTimeout(()=>{this.trigger("res.done",a)},200));this.dispatcher.done(a.no);this.config.meta!=this.config.req&&g.found(this.config.meta,a.no);if(a.err)return this.err=a.err,!0;if(this.err)return!0;const b=this.dispatcher.next();if(b)this.worker.push(this.taskWrap(b)),this.trigger("res.start",b);else return!0}taskFinish(){this.stream&&this.stream.push(this.dispatcher.total,{done:!0})}rtcInit(){const a=a=>{g.query(this.config.meta,a,(a,b)=>{if(this.stream)return(a=
this.stream.item(b))?a.data:a})};a(0);this.rtcLoop=setInterval(()=>{const b=this.dispatcher.rtcNext();if(b){var c=!1,d=g.getStats();this.trigger("rtc.stat",d,g.id);Object.keys(d).forEach(a=>{"open"==d[a].state&&(c=!0)});c&&(a(b.no),this.trigger("res.rtc.start",b))}else clearInterval(this.rtcLoop),this.rtcLoop=setInterval(()=>{const a=g.getStats();this.trigger("rtc.stat",a,g.id)},900)},600);g.register("data",({id:a,index:c,buffer:d})=>{d={no:c,data:d};this.stream&&this.config.meta==a&&(this.stream.item(c)||
(this.stream.push(d.no,d),g.found(this.config.meta,d.no),this.trigger("res.rtc.done",d)),this.dispatcher.done(d.no))});g.register("open",()=>{const a=g.getStats();this.trigger("rtc.stat",a)});g.register("close",()=>{const a=g.getStats();this.trigger("rtc.stat",a)});g.register("error",()=>{const a=g.getStats();this.trigger("rtc.stat",a)})}getResponse(){return this.stream.getResponse()}static rtc(){return g}}class W{constructor(a){this.data=new DataView(a);this.size=this.data.byteLength;this.byte=0}readVInt(a=
!1){var b=this.data.getUint8(this.byte);if(0==b)throw"Variable int is too large to parse";for(var c=0;8>c&&!(b>=Math.pow(2,7-c));c++);if(this.byte+c+1>this.size)throw"Missing bytes, not enough data to parse variable int";a||(b-=Math.pow(2,7-c));for(a=1;a<=c;a++)b*=Math.pow(2,8),b+=this.data.getUint8(this.byte+a);this.byte+=c+1;return b}readUInt(a){for(var b=0,c=0;c<a;c++)b*=Math.pow(2,8),b+=this.data.getUint8(this.byte+c);this.byte+=a;return b}}class G{constructor(){this.size=this.start=this.id=0;
this.value=this.meta=null;this.children=[]}setMeta(a){this.meta=a.type(this.id)}get name(){return this.meta.name}parseElements(a,b){let c=this.start+this.size;for(;a.byte<c;)this.children.push(this.parseElement(a,b))}parseElement(a,b){let c=new G;c.start=a.byte;c.id=a.readVInt(!0);c.size=a.readVInt();c.setMeta(b);c.meta.container?c.parseElements(a,b):c.value=a.readUInt(c.size);return c}}class X{constructor(){this.schema={};this.add(475249515,"Cues","master");this.add(187,"CuePoint","master");this.add(179,
"CueTime","uinteger");this.add(183,"CueTrackPositions","master");this.add(247,"CueTrack","uinteger");this.add(241,"CueClusterPosition","uinteger")}add(a,b,c){b={name:b,dataType:c,container:!1};"master"==c&&(b.container=!0);this.schema[a]=b}type(a){return this.schema[a]}}class Y{constructor(a){this.schema=new X;a=new W(a);this.root=new G;this.root.start=0;this.root.size=a.size;this.root.parseElements(a,this.schema)}get elements(){return this.root.children}get stat(){var a=this.elements[0];const b=
[];if(a.children)for(let c of a.children){const [d,e]=c.children;a=d.value;const [,f]=e.children;b.push({t:a,o:f.value})}return b}info(a,b){const c=this.stat,d=[];a=a.end-c[0].o+1;for(let e=0;e<c.length;e++)d.push({start:c[e].o+a,end:e<c.length-1?c[e+1].o+a-1:b-1,startTime:c[e].t,duration:e<c.length-1?c[e+1].t-c[e].t:c[e].t+6E3});return d}}class Z{constructor(a){this.buffer=a;this.data=new DataView(a)}parse(a){let b=0;const c=this.data.getUint8(b+8);b+=12;const d=this.data.getUint32(b+4);b+=8;let e,
f;0===c?(e=this.data.getUint32(b),f=this.data.getUint32(b+4),b+=8):(e=2**32*this.data.getUint32(b)+this.data.getUint32(b+4),f=(this.data.getUint32(b+8)<<32)+this.data.getUint32(b+12),b+=16);f+=a||this.data.byteLength;a=this.data.getUint16(b+2);b+=4;const h=[];let m=f,g=e;for(let c=0;c<a;c++){let a=this.data.getUint32(b);const c=a>>>31;a&=2147483647;const e=this.data.getUint32(b+4),f=m+a-1,k=m,l=k+"-"+f;b+=12;h.push({size:a,type:c,offset:m,duration:e,time:g,timescale:d,mediaRange:l,startRange:k,endRange:f,
durationSec:e/d,startTimeSec:g/d});m+=a;g+=e}return{version:c,timescale:d,earliestPresentationTime:e,firstOffset:f,referenceCount:a,references:h}}parseWebM(a){const {index:b,len:c}=a;return(new Y(this.buffer)).info(b,c)}}class aa{constructor(a,b,c,d){this.taskMap={};this.index=0;a=new Z(a);if(d)for(b=a.parseWebM(c),c=0;c<b.length;c++)d=b[c],a=c,this.taskMap[a]={m:d.start,n:d.end+1,no:a,begin:d.startTime/1E3};else for(b=a.parse(b),c=0;c<b.referenceCount;c++)d=b.references[c],a=c,this.taskMap[a]={m:d.startRange,
n:d.endRange+1,no:a,begin:d.startTimeSec}}get total(){return Object.keys(this.taskMap).length}next(){var a=this.taskMap[this.index];if(a&&!a.done&&!a.start)return this.index++,a.start=!0,a;for(a=this.index;a<this.total;a++){var b=this.taskMap[a];if(!b.done)return b.start=!0,b}for(a=0;a<this.total;a++)if(b=this.taskMap[a],!b.done)return b.start=!0,b}rtcNext(){for(let a=this.index;a<this.total;a++){const b=this.taskMap[a];if(!b.done&&!b.start)return b.start=!0,b}}getMap(){return this.taskMap}seekTo(a){if(a>=
this.total)throw Error("index error");this.index=a}done(a){this.taskMap[a]?this.taskMap[a].done=!0:console.error("error in done")}}class ba extends E{constructor(){super(...arguments);this.loaders=[]}async get(a,b,c){return await (new E({req:a,start:Number(b),end:Number(c),thread:1,thunk:1048576,meta:a})).start(!1).getResponse().arrayBuffer()}async attach(a,b){const c=new MediaSource;c.addEventListener("sourceopen",async()=>{try{const d=[],e=[],f=[],h=[];for(let m=0;m<b.length;m++){const {req:g,init:k,
index:l,mimeCodec:n,len:q,duration:r,meta:t}=b[m];let v={index:l,len:q,duration:r},w=/\.webm/.test(g);const y=await Promise.all([this.get(g,k.start,k.end+1),this.get(g,l.start,l.end+1)]),[B,z]=y;e.push(y);const x=new E({req:g,start:0,end:0,thread:this.config.thread,meta:t});this.loaders.push(x);x.dispatcher=new aa(z,Number(l.end)+1,v,w);const C=x.dispatcher.getMap();d.push(C);const D=x.start(!0).getResponse().body.getReader();if("open"!==c.readyState)return;const A=new I(a,D,c,n);x.refBuffer=A;f.push(()=>
{x.pause(!1);A.push(B).push(z)});h.push(A.wait());A.register("error",a=>{this.trigger("error",a);this.pause()});A.register("pause",()=>{x.pause(!0)});A.register("start",()=>{x.pause(!1)})}this.trigger("ready",this.loaders,d,e);await k(1E3);for(let a of f)a();await Promise.all(h)}catch(d){this.trigger("error",d),this.pause()}});c.addEventListener("sourceclosed",a=>{});c.addEventListener("sourceended",a=>{});this.video=a;this.mediaSource=c;a.src=URL.createObjectURL(c);this.timeUpdate=this.timeUpdate.bind(this);
a.addEventListener("timeupdate",this.timeUpdate)}timeUpdate(){if(this.video.buffered.length){const a=this.video.currentTime;for(let b=0;b<this.video.buffered.length;b++){const c=this.video.buffered.start(b),d=this.video.buffered.end(b);a>=c&&a<=d&&(600<d-a?this.pause():this.start())}}}start(){this.loaders.forEach(a=>a.pause(!1));return this}pause(){this.loaders.forEach(a=>a.pause(!0));return this}async destroy(){this.video.removeEventListener("timeupdate",this.timeUpdate);window.URL.revokeObjectURL(this.video.src);
this.loaders.forEach(a=>a.destroy());this.loaders=[];let a=0;for(;5>a++;)if("open"===this.mediaSource.readyState){const a=[];for(let b of this.mediaSource.activeSourceBuffers)a.push(b.updating);if(a.every(a=>!a))return this.mediaSource.endOfStream();await k(20)}this.mediaSource=null}seekTo(a){this.loaders.forEach(b=>b.seekTo(a))}async save(a){const b=await this.getResponse().blob();if(window.navigator.msSaveOrOpenBlob)return navigator.msSaveBlob(b,a);const c=document.createElement("a");c.style.display=
"none";c.href=window.URL.createObjectURL(b);c.download=a;document.body.appendChild(c);c.click();setTimeout(function(){document.body.removeChild(c);window.URL.revokeObjectURL(c.href)},200)}}return ba});
